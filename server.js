// –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π
import express from 'express'; // –í–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
import http from 'http'; // –ù–∞—Ç–∏–≤–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å HTTP
import { Server } from 'socket.io'; // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≤–µ–±-—Å–æ–∫–µ—Ç–æ–≤ (—Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)
import cors from 'cors'; // Middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ CORS (–º–µ–∂—Å–∞–π—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)

// –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const app = express();

// –°–æ–∑–¥–∞–Ω–∏–µ HTTP-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ Express
const server = http.createServer(app);

// ============== –ù–ê–°–¢–†–û–ô–ö–ê CORS ==============
// Middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Cross-Origin Resource Sharing
// –†–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –ª—é–±—ã—Ö –¥–æ–º–µ–Ω–æ–≤
app.use(cors({
    origin: "*", // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã —Å –ª—é–±–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    methods: ["GET", "POST"] // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ GET –∏ POST –º–µ—Ç–æ–¥—ã
}));

// ============== –°–û–ó–î–ê–ù–ò–ï SOCKET.IO –°–ï–†–í–ï–†–ê ==============
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO —Å–µ—Ä–≤–µ—Ä–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ CORS
const io = new Server(server, {
    cors: {
        origin: "*", // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –ª—é–±—ã—Ö –¥–æ–º–µ–Ω–æ–≤
        methods: ["GET", "POST"] // –†–∞–∑—Ä–µ—à–∞–µ–º—ã–µ HTTP –º–µ—Ç–æ–¥—ã
    }
});

// ============== –•–†–ê–ù–ò–õ–ò–©–ï –î–ê–ù–ù–´–• ==============
// Map –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
// –ö–ª—é—á: socket.id (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
// –ó–Ω–∞—á–µ–Ω–∏–µ: –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const onlineUsers = new Map();

// ============== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô SOCKET.IO ==============

// –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
io.on('connection', (socket) => {
    // socket - –æ–±—ä–µ–∫—Ç, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    console.log('‚úÖ –ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:', socket.id);
    // socket.id - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

    // ============== –°–û–ë–´–¢–ò–ï: –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –í–û–®–ï–õ –í –°–ò–°–¢–ï–ú–£ ==============
    // –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ 'user_joined' —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    socket.on('user_joined', (userData) => {
        console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª:', userData.nickname);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Map
        onlineUsers.set(socket.id, {
            id: socket.id, // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (–¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
            socketId: socket.id, // ID —Å–æ–∫–µ—Ç–∞ –¥–ª—è —Å–≤—è–∑–∏
            nickname: userData.nickname, // –ù–∏–∫–Ω–µ–π–º –∏–∑ –∫–ª–∏–µ–Ω—Ç–∞
            avatar: userData.avatar // –ê–≤–∞—Ç–∞—Ä –∏–∑ –∫–ª–∏–µ–Ω—Ç–∞
        });

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Map –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞–º
        const usersArray = Array.from(onlineUsers.values());

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –í–°–ï–ú –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
        // io.emit - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º, –≤–∫–ª—é—á–∞—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        io.emit('online_users_update', usersArray);
        console.log('üìä –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', usersArray.length);
    });

    // ============== –°–û–ë–´–¢–ò–ï: –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ==============
    // –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞
    socket.on('search_users', (searchTerm) => {
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∫ –º–∞—Å—Å–∏–≤
        const usersArray = Array.from(onlineUsers.values());

        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
        // 1. –ù–∏–∫–Ω–µ–π–º —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Å–∫–æ–º—É—é —Å—Ç—Ä–æ–∫—É (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
        // 2. –ò—Å–∫–ª—é—á–∞–µ–º —Å–∞–º–æ–≥–æ —Å–µ–±—è –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
        const filteredUsers = usersArray.filter(user =>
            user.nickname.toLowerCase().includes(searchTerm.toLowerCase()) &&
            user.socketId !== socket.id
        );

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ–ª—å–∫–æ –û–¢–ü–†–ê–í–ò–¢–ï–õ–Æ –∑–∞–ø—Ä–æ—Å–∞
        // socket.emit - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–º—É –∫–ª–∏–µ–Ω—Ç—É
        socket.emit('search_results', filteredUsers);
    });

    // ============== –°–û–ë–´–¢–ò–ï: –û–¢–ü–†–ê–í–ö–ê –õ–ò–ß–ù–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø ==============
    socket.on('send_private_message', (data) => {
        // data = { to: '–Ω–∏–∫–Ω–µ–π–º', text: '—Å–æ–æ–±—â–µ–Ω–∏–µ' }

        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ
        const fromUser = onlineUsers.get(socket.id);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –≤ onlineUsers
        if (!fromUser) {
            console.log('‚ùå –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        }

        console.log('üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç', fromUser.nickname, '–∫', data.to);

        // –ò—â–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–æ –Ω–∏–∫–Ω–µ–π–º—É –≤ onlineUsers
        // Array.from(onlineUsers.entries()) –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç Map –≤ –º–∞—Å—Å–∏–≤ –ø–∞—Ä [key, value]
        const recipientEntry = Array.from(onlineUsers.entries()).find(
            ([id, user]) => user.nickname === data.to
        );

        // –ï—Å–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –ò –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (recipientEntry && fromUser) {
            const [recipientId, recipientUser] = recipientEntry;
            // recipientId - socket.id –ø–æ–ª—É—á–∞—Ç–µ–ª—è
            // recipientUser - –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª—è

            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            const messageData = {
                id: Date.now(), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏
                from: fromUser.nickname, // –ù–∏–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                fromAvatar: fromUser.avatar, // –ê–≤–∞—Ç–∞—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                to: data.to, // –ù–∏–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                text: data.text, // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                timestamp: new Date().toLocaleTimeString() // –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            };

            console.log('‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:', recipientUser.nickname);

            // ============== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==============

            // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—é (–±–µ–∑ —Ñ–ª–∞–≥–∞ isOwn)
            // socket.to(recipientId) - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            socket.to(recipientId).emit('new_private_message', messageData);

            // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é —Å —Ñ–ª–∞–≥–æ–º isOwn = true
            // –≠—Ç–æ —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç –º–æ–≥ –æ—Ç–ª–∏—á–∞—Ç—å —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —á—É–∂–∏—Ö
            socket.emit('new_private_message', { ...messageData, isOwn: true });

        } else {
            // –ï—Å–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
            console.log('‚ùå –ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω:', data.to);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
            socket.emit('error_message', {
                text: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.to} –Ω–µ –≤ —Å–µ—Ç–∏`
            });
        }
    });

    // ============== –°–û–ë–´–¢–ò–ï: –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==============
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    socket.on('disconnect', () => {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ socket.id
        const user = onlineUsers.get(socket.id);

        if (user) {
            // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Map
            onlineUsers.delete(socket.id);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ–º –æ—Å—Ç–∞–≤—à–∏–º—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            const usersArray = Array.from(onlineUsers.values());
            io.emit('online_users_update', usersArray);

            console.log('üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è:', user.nickname);
        }
    });
});

// ============== HTTP –ú–ê–†–®–†–£–¢–´ ==============

// –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞
// GET –∑–∞–ø—Ä–æ—Å –Ω–∞ http://localhost:3001/status
app.get('/status', (req, res) => {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Ä–≤–µ—Ä–µ
    res.json({
        status: 'OK',
        usersOnline: onlineUsers.size, // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        message: 'Mango Server —Ä–∞–±–æ—Ç–∞–µ—Ç!'
    });
});

// ============== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ==============
const PORT = process.env.PORT || 3001; // –ü–æ—Ä—Ç –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ 3001
const HOST = '0.0.0.0'; // –í–∞–∂–Ω–æ: —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ IP –∞–¥—Ä–µ—Å—É

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
server.listen(PORT, HOST, () => {
    console.log(`\nüéâ Mango Server –∑–∞–ø—É—â–µ–Ω!`);
    console.log(`üìç –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø: http://localhost:${PORT}`);
    console.log(`üåê –°–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø: http://–í–ê–®_IP:${PORT}`);
    console.log(`üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞: http://localhost:${PORT}/status\n`);

    console.log('üí° –ß—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞:');
    console.log('1. –£–∑–Ω–∞–π —Å–≤–æ–π IP –∞–¥—Ä–µ—Å (ipconfig / ifconfig)');
    console.log('2. –ó–∞–º–µ–Ω–∏ localhost –Ω–∞ —Ç–≤–æ–π IP –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞');
    console.log('3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–±–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –æ–¥–Ω–æ–π WiFi —Å–µ—Ç–∏');
});